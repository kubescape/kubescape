name: 02-create_release
on:
  workflow_dispatch:
    inputs:
      CLIENT:
        required: false
        type: string
        default: "test"
      IMAGE_TAG:
        required: true
        type: string
      CO_SIGN:
        type: boolean
        required: false
        default: false
      PLATFORMS:
        type: boolean
        required: false
        default: false
jobs:
  binary-build:
    needs: [retag]
    uses: ./.github/workflows/b-binary-build-and-e2e-tests.yaml
    with:
      COMPONENT_NAME: kubescape
      CGO_ENABLED: 1
      GO111MODULE: ""
      GO_VERSION: "1.20"
      RELEASE: ${{ needs.retag.outputs.NEW_TAG }}
      CLIENT: release
    secrets: inherit
  create-release:
    permissions:
      contents: write
    needs: [retag, binary-build]
    uses: ./.github/workflows/c-create-release.yaml
    with:
      RELEASE_NAME: "Release ${{ needs.retag.outputs.NEW_TAG }}"
      TAG: ${{ needs.retag.outputs.NEW_TAG }}
      DRAFT: false
    secrets: inherit
  publish-image:
    permissions:
      id-token: write
      packages: write
      contents: read
    uses: ./.github/workflows/d-publish-image.yaml
    needs: [create-release, retag]
    with:
      client: "image-release"
      image_name: "quay.io/${{ github.repository_owner }}/kubescape-cli"
      image_tag: ${{ needs.retag.outputs.NEW_TAG }}
      support_platforms: true
      cosign: true
    secrets: inherit
