name: 01-code_review_approved
on:
  pull_request_review:
    types: [submitted]
    branches:
      - 'master'
      - 'main'
    paths-ignore:
      - '**.yaml'
      - '**.md'
      - '**.sh'
      - 'website/*'
      - 'examples/*'
      - 'docs/*'
      - 'build/*'
      - '.github/*'

env:
  CUSTOMER: ${{ secrets.CUSTOMER }}
  USERNAME: ${{ secrets.USERNAME }}
  PASSWORD: ${{ secrets.PASSWORD }}
  CLIENT_ID: ${{ secrets.CLIENT_ID_PROD }}
  SECRET_KEY: ${{ secrets.SECRET_KEY_PROD }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}

concurrency:
  group: code-review-approved
  cancel-in-progress: true

jobs:

  binary-build:
    if: ${{ ${{ env.CUSTOMER }} && 
            ${{ env.USERNAME }} && 
            ${{ env.PASSWORD }} && 
            ${{ env.CLIENT_ID_PROD }} && 
            ${{ env.SECRET_KEY_PROD }} && 
            ${{ env.REGISTRY_USERNAME }} && 
            ${{ env.REGISTRY_PASSWORD }} &&
            github.event.review.state == 'approved' && 
            contains( github.event.pull_request.labels.*.name, 'trigger-integration-test') && 
            github.event.pull_request.base.ref == 'master' }} ## run only if labeled as "trigger-integration-test" and base branch is master
    uses: ./.github/workflows/b-binary-build-and-e2e-tests.yaml
    with:
      COMPONENT_NAME: kubescape
      CGO_ENABLED: 1
      GO111MODULE: ""
      GO_VERSION: "1.19"
      RELEASE: ${{ github.ref_name}}
      CLIENT: test
    secrets: inherit


  merge-to-master:
    needs: binary-build
    if: ${{ env.GH_PERSONAL_ACCESS_TOKEN && 
            (github.event.review.state == 'approved' && github.event.pull_request.base.ref == 'master') && 
            (always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped')) && !(contains(needs.*.result, 'failure')) && !(contains(needs.*.result, 'cancelled'))) }}
    env:
      GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: merge-to-master
        uses: pascalgn/automerge-action@v0.15.5
        env:
          GITHUB_TOKEN: "${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}"
          MERGE_COMMIT_MESSAGE: "Merge to master - PR number: {pullRequest.number}"
          MERGE_ERROR_FAIL: "true"
          MERGE_METHOD: "merge"
          MERGE_LABELS: ""
          UPDATE_LABELS: ""